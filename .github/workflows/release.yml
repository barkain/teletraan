name: Release Desktop App

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g. v0.2.0). Leave empty for artifact-only build."
        required: false
        type: string

# Prevent multiple release builds from running simultaneously for the same ref.
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "20"
  PYTHON_VERSION: "3.12"

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest      # Apple Silicon runner
            target: aarch64-apple-darwin
            label: macOS-arm64
            os: macOS
            sidecar_ext: ""
          - platform: macos-13          # Intel Mac runner
            target: x86_64-apple-darwin
            label: macOS-x64
            os: macOS
            sidecar_ext: ""
          - platform: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            label: Linux-x64
            os: Linux
            sidecar_ext: ""
          - platform: windows-latest
            target: x86_64-pc-windows-msvc
            label: Windows-x64
            os: Windows
            sidecar_ext: ".exe"

    runs-on: ${{ matrix.platform }}
    name: Build (${{ matrix.label }})

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ── Linux system dependencies ──────────────────────────────
      # Tauri 2 on Linux requires webkit2gtk 4.1 and related libs.

      - name: Install Linux system dependencies
        if: matrix.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libssl-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            libsoup-3.0-dev \
            libjavascriptcoregtk-4.1-dev

      # ── Toolchain setup ────────────────────────────────────────

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: |
            frontend/package-lock.json
            desktop/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache Rust build artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            desktop/src-tauri/target
          key: rust-${{ matrix.target }}-${{ hashFiles('desktop/src-tauri/Cargo.lock', 'desktop/src-tauri/Cargo.toml') }}
          restore-keys: |
            rust-${{ matrix.target }}-

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Cache uv packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            ~/AppData/Local/uv/cache
          key: uv-${{ runner.os }}-${{ hashFiles('backend/uv.lock') }}
          restore-keys: |
            uv-${{ runner.os }}-

      # ── Frontend: static export ────────────────────────────────

      - name: Install frontend dependencies
        run: npm ci
        working-directory: frontend

      - name: Build frontend (static export for desktop)
        run: npx next build --config next.config.desktop.mjs
        working-directory: frontend

      - name: Copy frontend export to desktop/dist
        shell: bash
        run: |
          rm -rf desktop/dist
          cp -r frontend/out desktop/dist

      # ── Backend: PyInstaller sidecar ───────────────────────────

      - name: Install backend dependencies
        run: uv sync
        working-directory: backend

      - name: Install PyInstaller
        run: uv run pip install pyinstaller
        working-directory: backend

      - name: Bundle backend with PyInstaller (Unix)
        if: matrix.os != 'Windows'
        working-directory: backend
        run: |
          uv run pyinstaller \
            --onefile \
            --name teletraan-backend \
            --hidden-import uvicorn.logging \
            --hidden-import uvicorn.loops.auto \
            --hidden-import uvicorn.protocols.http.auto \
            --hidden-import uvicorn.protocols.websockets.auto \
            --hidden-import uvicorn.lifespan.on \
            --hidden-import aiosqlite \
            --collect-data sqlalchemy \
            main.py

      - name: Bundle backend with PyInstaller (Windows)
        if: matrix.os == 'Windows'
        working-directory: backend
        shell: pwsh
        run: |
          uv run pyinstaller `
            --onefile `
            --name teletraan-backend `
            --hidden-import uvicorn.logging `
            --hidden-import uvicorn.loops.auto `
            --hidden-import uvicorn.protocols.http.auto `
            --hidden-import uvicorn.protocols.websockets.auto `
            --hidden-import uvicorn.lifespan.on `
            --hidden-import aiosqlite `
            --collect-data sqlalchemy `
            main.py

      # ── Copy sidecar binary with target-triple suffix ──────────

      - name: Copy sidecar binary (Unix)
        if: matrix.os != 'Windows'
        run: |
          mkdir -p desktop/src-tauri/binaries
          cp backend/dist/teletraan-backend \
             desktop/src-tauri/binaries/teletraan-backend-${{ matrix.target }}
          chmod +x desktop/src-tauri/binaries/teletraan-backend-${{ matrix.target }}

      - name: Copy sidecar binary (Windows)
        if: matrix.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path desktop/src-tauri/binaries | Out-Null
          Copy-Item backend/dist/teletraan-backend.exe `
            desktop/src-tauri/binaries/teletraan-backend-${{ matrix.target }}.exe

      # ── Tauri build ────────────────────────────────────────────

      - name: Install desktop (Tauri CLI) dependencies
        run: npm ci
        working-directory: desktop

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # TODO: macOS code signing — set these secrets when ready:
          # APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          # APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          # APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          # APPLE_ID: ${{ secrets.APPLE_ID }}
          # APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          # APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        with:
          projectPath: desktop
          tauriScript: npx tauri
          args: --target ${{ matrix.target }}
          # Only create/attach to a GitHub Release when triggered by a tag push
          # or a manual run with a tag provided.
          tagName: ${{ github.ref_type == 'tag' && github.ref_name || inputs.tag || '' }}
          releaseName: ${{ github.ref_type == 'tag' && format('Teletraan {0}', github.ref_name) || (inputs.tag && format('Teletraan {0}', inputs.tag)) || '' }}
          releaseBody: |
            ## Teletraan Desktop

            Download the installer for your platform below.

            | Platform | File |
            |----------|------|
            | macOS (Apple Silicon) | `.dmg` |
            | macOS (Intel) | `.dmg` |
            | Linux | `.AppImage` / `.deb` |
            | Windows | `.msi` / `.exe` (NSIS) |
          releaseDraft: true
          prerelease: false

      # ── Upload build artifacts (always available via Actions) ──

      - name: Upload macOS artifacts
        if: matrix.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: teletraan-${{ matrix.label }}
          path: |
            desktop/src-tauri/target/${{ matrix.target }}/release/bundle/dmg/*.dmg
            desktop/src-tauri/target/${{ matrix.target }}/release/bundle/macos/*.app
          if-no-files-found: warn
          retention-days: 30

      - name: Upload Linux artifacts
        if: matrix.os == 'Linux'
        uses: actions/upload-artifact@v4
        with:
          name: teletraan-${{ matrix.label }}
          path: |
            desktop/src-tauri/target/${{ matrix.target }}/release/bundle/appimage/*.AppImage
            desktop/src-tauri/target/${{ matrix.target }}/release/bundle/deb/*.deb
          if-no-files-found: warn
          retention-days: 30

      - name: Upload Windows artifacts
        if: matrix.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: teletraan-${{ matrix.label }}
          path: |
            desktop/src-tauri/target/${{ matrix.target }}/release/bundle/nsis/*.exe
            desktop/src-tauri/target/${{ matrix.target }}/release/bundle/msi/*.msi
          if-no-files-found: warn
          retention-days: 30
