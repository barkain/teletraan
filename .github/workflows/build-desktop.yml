name: Build Desktop App

on:
  workflow_dispatch: # Manual trigger from GitHub UI
  push:
    tags:
      - "v*" # Build on version tags (e.g. v0.1.0)

# Prevent multiple builds from running simultaneously for the same ref.
concurrency:
  group: desktop-build-${{ github.ref }}
  cancel-in-progress: true

env:
  # Shared across all jobs
  NODE_VERSION: "20"
  PYTHON_VERSION: "3.12"

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            target: aarch64-apple-darwin
            label: macOS-arm64
          - platform: macos-latest
            target: x86_64-apple-darwin
            label: macOS-x64
          - platform: windows-latest
            target: x86_64-pc-windows-msvc
            label: Windows-x64

    runs-on: ${{ matrix.platform }}
    name: Build (${{ matrix.label }})

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ── Toolchain setup ──────────────────────────────────────

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: |
            frontend/package-lock.json
            desktop/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache Rust build artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            desktop/src-tauri/target
          key: rust-${{ matrix.target }}-${{ hashFiles('desktop/src-tauri/Cargo.lock', 'desktop/src-tauri/Cargo.toml') }}
          restore-keys: |
            rust-${{ matrix.target }}-

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      # ── Frontend: static export ──────────────────────────────

      - name: Install frontend dependencies
        run: npm ci
        working-directory: frontend

      - name: Build frontend (static export for desktop)
        run: npx next build --config next.config.desktop.mjs
        working-directory: frontend

      - name: Copy frontend export to desktop/dist
        shell: bash
        run: |
          rm -rf desktop/dist
          cp -r frontend/out desktop/dist

      # ── Backend: PyInstaller sidecar ─────────────────────────

      - name: Cache uv packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: uv-${{ runner.os }}-${{ hashFiles('backend/uv.lock') }}
          restore-keys: |
            uv-${{ runner.os }}-

      - name: Install backend dependencies
        run: uv sync
        working-directory: backend

      - name: Install PyInstaller
        run: uv run pip install pyinstaller
        working-directory: backend

      - name: Bundle backend with PyInstaller (macOS)
        if: runner.os == 'macOS'
        working-directory: backend
        run: |
          uv run pyinstaller \
            --onefile \
            --name teletraan-backend \
            --hidden-import uvicorn.logging \
            --hidden-import uvicorn.loops.auto \
            --hidden-import uvicorn.protocols.http.auto \
            --hidden-import uvicorn.protocols.websockets.auto \
            --hidden-import uvicorn.lifespan.on \
            --hidden-import aiosqlite \
            --collect-data sqlalchemy \
            main.py

      - name: Bundle backend with PyInstaller (Windows)
        if: runner.os == 'Windows'
        working-directory: backend
        shell: pwsh
        run: |
          uv run pyinstaller `
            --onefile `
            --name teletraan-backend `
            --hidden-import uvicorn.logging `
            --hidden-import uvicorn.loops.auto `
            --hidden-import uvicorn.protocols.http.auto `
            --hidden-import uvicorn.protocols.websockets.auto `
            --hidden-import uvicorn.lifespan.on `
            --hidden-import aiosqlite `
            --collect-data sqlalchemy `
            main.py

      # ── Copy sidecar binary with target-triple suffix ────────

      - name: Copy sidecar binary (macOS)
        if: runner.os == 'macOS'
        run: |
          mkdir -p desktop/src-tauri/binaries
          cp backend/dist/teletraan-backend \
             desktop/src-tauri/binaries/teletraan-backend-${{ matrix.target }}
          chmod +x desktop/src-tauri/binaries/teletraan-backend-${{ matrix.target }}

      - name: Copy sidecar binary (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path desktop/src-tauri/binaries | Out-Null
          Copy-Item backend/dist/teletraan-backend.exe `
            desktop/src-tauri/binaries/teletraan-backend-${{ matrix.target }}.exe

      # ── Tauri build ──────────────────────────────────────────

      - name: Install Tauri CLI dependencies
        run: npm ci
        working-directory: desktop

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: desktop
          tauriScript: npx tauri
          args: --target ${{ matrix.target }}
          tagName: ${{ startsWith(github.ref, 'refs/tags/v') && github.ref_name || '' }}
          releaseName: ${{ startsWith(github.ref, 'refs/tags/v') && format('Teletraan {0}', github.ref_name) || '' }}
          releaseBody: "Download the installer for your platform below."
          releaseDraft: false
          prerelease: false

      # ── Upload artifacts (always, for workflow_dispatch runs) ──

      - name: Upload macOS artifacts
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: teletraan-${{ matrix.label }}
          path: |
            desktop/src-tauri/target/${{ matrix.target }}/release/bundle/dmg/*.dmg
            desktop/src-tauri/target/${{ matrix.target }}/release/bundle/macos/*.app
          if-no-files-found: error
          retention-days: 30

      - name: Upload Windows artifacts
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: teletraan-${{ matrix.label }}
          path: |
            desktop/src-tauri/target/${{ matrix.target }}/release/bundle/nsis/*.exe
            desktop/src-tauri/target/${{ matrix.target }}/release/bundle/msi/*.msi
          if-no-files-found: error
          retention-days: 30
